# Техническое задание: Система прогнозирования и проактивных уведомлений для VL.OFF

## 1. ОБЩЕЕ ОПИСАНИЕ

### 1.1 Назначение системы
Система прогнозирования отключений коммунальных ресурсов на основе исторических данных с отправкой проактивных уведомлений пользователям.

### 1.2 Цель внедрения
- Повышение удовлетворенности пользователей через proactivity
- Увеличение retention и вовлеченности
- Создание монетизируемого Premium-функционала
- Дифференциация от конкурентов

### 1.3 Область применения
- Веб-приложение VL.OFF (vl.ru/off)
- Мобильные приложения (iOS/Android)
- Email-рассылки
- SMS (Premium)

---

## 2. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 2.1 FR-1: Модуль прогнозирования

#### FR-1.1: Расчет вероятности отключений
**Требование**: Система должна рассчитывать вероятность отключения для каждого здания на период до 7 дней

**Алгоритм** (упрощенный для MVP):
```
probability = (historical_frequency / total_days) × monthly_factor × weekday_factor

где:
- historical_frequency: количество перебоев типа за период
- total_days: общее количество дней в историческом периоде
- monthly_factor: коэффициент сезонности (1.0-2.0)
- weekday_factor: коэффициент дня недели (0.8-1.5)
```

**Входные данные:**
- ID здания
- Дата для прогноза
- Исторические данные о перебоях
- Календарные данные (месяц, день недели)

**Выходные данные:**
- Словарь вероятностей по типам отключений (electricity, cold_water, hot_water, heat)
- Значение вероятности: 0.0 - 1.0

**Пример:**
```python
{
    "electricity": 0.15,      # 15% вероятность
    "cold_water": 0.05,       # 5% вероятность
    "hot_water": 0.20,        # 20% вероятность
    "heat": 0.10              # 10% вероятность
}
```

#### FR-1.2: Батчинг прогнозов
**Требование**: Система должна обновлять прогнозы для всех зданий один раз в день

**Расписание:**
- Время запуска: 00:00 MSK
- Частота: Ежедневно
- Приоритет: Low (не критично, если пропустит 1 день)

---

### 2.2 FR-2: Модуль уведомлений

#### FR-2.1: Фильтрация пользователей для уведомлений
**Требование**: Отправлять уведомления только пользователям с высокой вероятностью и включенными настройками

**Логика фильтрации:**
```
IF user_subscribed_to_notifications AND
   probability > user_notification_threshold AND
   notification_time_in_range THEN
   SEND notification
```

**Бизнес-правило:**
- По умолчанию threshold = 0.5 (50%)
- Пользователь может изменить в настройках (0.3 - 0.8)

#### FR-2.2: Уведомления по каналам

**Канал 1: Push-уведомления**
- **Триггер**: Вероятность > threshold
- **Время**: 08:00 MSK
- **Частота**: Максимум 1 раз в день
- **Формат**: "⚠️ Высокая вероятность отключения [тип] сегодня (65%)"
- **Стоимость**: Бесплатно

**Канал 2: Email**
- **Триггер**: Вероятность > 0.7 ИЛИ пользователь выбрал в настройках
- **Время**: 09:00 MSK
- **Частота**: Максимум 1 раз в день
- **Формат**: HTML с детальной статистикой
- **Стоимость**: Бесплатно

**Канал 3: SMS (Premium)**
- **Триггер**: Вероятность > 0.75 И пользователь Premium
- **Время**: Мгновенно при расчете
- **Частота**: Не более 1 раза в день
- **Формат**: "VL.OFF: Вероятность отключения [тип] 80%. Адрес: [адрес]. Время: ~[часы]"
- **Стоимость**: Требуется Premium подписка

---

### 2.3 FR-3: Пользовательский интерфейс

#### FR-3.1: Страница прогноза для адреса
**Требование**: Отображать прогноз на 7 дней для выбранного адреса пользователя

**Элементы интерфейса:**
1. Заголовок с адресом
2. Карточки для каждого из 7 дней
3. Для каждого дня:
   - Дата (день недели, число)
   - Иконки типов отключений с процентами
   - Цветовая индикация (зеленый/желтый/красный)
4. Кнопка "Настроить уведомления"
5. Ссылка на историю отключений

**Расположение**: `/profile/addresses/[address_id]/forecast`

#### FR-3.2: Настройки уведомлений
**Требование**: Позволять пользователю настраивать параметры уведомлений

**Разделы настроек:**
1. Выбор типов отключений (чекбоксы: электричество, холодная вода, горячая вода, отопление)
2. Порог вероятности (слайдер: 30% - 80%)
3. Каналы доставки (чекбоксы: Push, Email, SMS)
4. "Тихие часы" (выбор времени: например, 22:00 - 08:00)
5. Сохранение настроек

**Расположение**: `/settings/notifications`

---

## 3. НЕФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 3.1 NFR-1: Производительность
- Время расчета прогноза для одного здания: < 1 секунда
- Время обновления всех прогнозов: < 30 минут (для 21,000 зданий)
- Время загрузки страницы прогноза: < 2 секунды
- Latency push-уведомлений: < 5 минут от момента расчетов

### 3.2 NFR-2: Масштабируемость
- Система должна выдерживать до 100,000 активных пользователей
- Поддержка до 100,000 зданий
- Горизонтальное масштабирование через load balancer

### 3.3 NFR-3: Надежность
- Uptime: 99.5% (допускается до 3.6 часов простоя в месяц)
- Data retention: исторические данные хранятся минимум 2 года
- Backup прогнозов: ежедневный, восстановление за 15 минут

### 3.4 NFR-4: Безопасность
- Аутентификация через JWT токены
- Валидация всех входных данных
- Rate limiting для API: 100 запросов в минуту на пользователя
- Персональные данные (адреса) шифруются в базе

### 3.5 NFR-5: Удобство использования
- Адаптивный дизайн (mobile-first)
- Поддержка iOS 13+, Android 8+
- Доступность (WCAG 2.1 Level AA)
- Многоязычность (русский язык)

---

## 4. ЛОГИЧЕСКАЯ МОДЕЛЬ ДАННЫХ

### 4.1 Сущности

#### 4.1.1 User (Пользователь)
```
- user_id (PK, UUID)
- email (String, Unique)
- phone (String, Optional)
- subscription_type (Enum: free, premium)
- created_at (Timestamp)
- updated_at (Timestamp)
- notification_settings_id (FK)
```

#### 4.1.2 UserAddress (Адреса пользователя)
```
- user_address_id (PK, UUID)
- user_id (FK)
- building_id (FK)
- is_primary (Boolean)
- created_at (Timestamp)
```

#### 4.1.3 Building (Здание)
```
- building_id (PK, String)
- street_id (FK)
- number (String)
- district_id (FK)
- coordinates (JSON: lat, lon)
- created_at (Timestamp)
```

#### 4.1.4 Forecast (Прогноз)
```
- forecast_id (PK, UUID)
- building_id (FK)
- forecast_date (Date)
- electricity_probability (Float, 0.0-1.0)
- cold_water_probability (Float)
- hot_water_probability (Float)
- heat_probability (Float)
- calculated_at (Timestamp)
- expires_at (Timestamp)
```

#### 4.1.5 NotificationSettings (Настройки уведомлений)
```
- settings_id (PK, UUID)
- user_id (FK, Unique)
- electricity_enabled (Boolean)
- cold_water_enabled (Boolean)
- hot_water_enabled (Boolean)
- heat_enabled (Boolean)
- probability_threshold (Float, default 0.5)
- push_enabled (Boolean)
- email_enabled (Boolean)
- sms_enabled (Boolean, premium only)
- quiet_hours_start (Time)
- quiet_hours_end (Time)
```

#### 4.1.6 HistoricalBlackout (Исторические данные о перебоях)
```
- blackout_id (PK, String)
- building_id (FK)
- start_date (Timestamp)
- end_date (Timestamp)
- type (Enum: electricity, cold_water, hot_water, heat)
- duration_hours (Float)
- description (Text)
- initiator_name (String)
- source (String)
```

### 4.2 Связи (Relationships)

```
User (1) ──< (N) UserAddress
User (1) ──< (1) NotificationSettings
Building (1) ──< (N) UserAddress
Building (1) ──< (N) Forecast
Building (1) ──< (N) HistoricalBlackout
```

### 4.3 Индексы (для оптимизации)

```sql
CREATE INDEX idx_building_forecast ON forecasts(building_id, forecast_date);
CREATE INDEX idx_user_addresses ON user_addresses(user_id, is_primary);
CREATE INDEX idx_historical_blackouts ON historical_blackouts(building_id, start_date);
CREATE INDEX idx_forecasts_expires ON forecasts(expires_at) WHERE expires_at > NOW();
```

---

## 5. БИЗНЕС-ПРАВИЛА

### 5.1 BR-1: Расчет прогноза
**Правило**: Прогноз рассчитывается ежедневно в 00:00 для всех зданий

**Исключения**:
- Если данных недостаточно (< 10 исторических перебоев типа), вероятность = 0.0
- Если данные старше 2 лет, их вес уменьшается на 50%

### 5.2 BR-2: Отправка уведомлений
**Правило**: Не более 1 уведомления в день на пользователя

**Логика выбора типа уведомления**:
1. SMS (если Premium и вероятность > 0.75)
2. Push (если включен и вероятность > threshold)
3. Email (если включен и вероятность > 0.7)

### 5.3 BR-3: Персонализация
**Правило**: Уведомления отправляются только для адресов в профиле пользователя

**Исключения**: Если у пользователя нет адресов, показывать общий прогноз по городу

### 5.4 BR-4: "Тихие часы"
**Правило**: В период с 22:00 до 08:00 push-уведомления не отправляются (если включено)

**Исключение**: SMS отправляются всегда (критичные случаи)

---

## 6. ДИАГРАММЫ

### 6.1 Sequence Diagram: Расчет и отправка прогноза

```
0:00 MSK - Ежедневное задание

┌─────────┐     ┌──────────┐     ┌──────────┐     ┌─────────┐     ┌──────┐
│Scheduler│     │Forecast  │     │Database  │     │Push     │     │User  │
│         │     │Service   │     │          │     │Service  │     │      │
└────┬────┘     └────┬─────┘     └────┬─────┘     └────┬────┘     └──┬───┘
     │               │                 │                │             │
     │─trigger──────>│                 │                │             │
     │               │                 │                │             │
     │               │──get buildings─>│                │             │
     │               │<─return IDs─────│                │             │
     │               │                 │                │             │
     │               │──calculate─────>│                │             │
     │               │                 │                │             │
     │               │──save forecast─>│                │             │
     │               │                 │                │             │
     │               │──get users─────>│                │             │
     │               │<─return users───│                │             │
     │               │                 │                │             │
     │               │──filter users──>│                │             │
     │               │                 │                │             │
8:00 MSK - Отправка уведомлений

     │               │──send push─────>│                │             │
     │               │                 │───────────────>│             │
     │               │                 │                │             │
```

### 6.2 BPMN: Процесс обработки запроса прогноза

```
┌────────────────────────────────────────────────────────────────────┐
│                        Запрос прогноза                             │
│                    GET /api/forecast/{building_id}                  │
└────────────────────────────┬───────────────────────────────────────┘
                             │
                             ▼
                    ┌────────────────┐
                    │ Аутентификация │
                    └───────┬────────┘
                            │
                            ▼
                    ┌────────────────┐
                    │Проверка прав   │
                    │доступа         │
                    └───────┬────────┘
                            │
                            ▼
                    ┌────────────────┐
                    │Кэш проверка    │
                    │TTL: 24 часа    │
                    └───────┬────────┘
                            │
                    ┌───────┴───────┐
                    │               │
                  Cache HIT      Cache MISS
                    │               │
                    ▼               ▼
            ┌───────────┐   ┌─────────────┐
            │Вернуть из │   │Запросить из │
            │кэша       │   │БД           │
            └───────────┘   └──────┬──────┘
                                   │
                                   ▼
                          ┌────────────────┐
                          │Рассчитать      │
                          │прогноз         │
                          └──────┬─────────┘
                                 │
                                 ▼
                          ┌────────────────┐
                          │Сохранить в БД  │
                          │и кэше          │
                          └──────┬─────────┘
                                 │
                                 ▼
                          ┌────────────────┐
                          │Вернуть         │
                          │результат       │
                          └────────────────┘
```

---

## 7. API СПЕЦИФИКАЦИЯ

### 7.1 Endpoint: GET /api/v1/forecast

**Описание**: Получить прогноз для указанного здания

**Параметры**:
- `building_id` (required): ID здания
- `days` (optional): Количество дней вперед (default: 7, max: 14)

**Headers**:
- `Authorization: Bearer {JWT_TOKEN}`

**Response 200:**
```json
{
  "building_id": "f6d2bac4f23afdb064b5a2cb89b95f3a",
  "address": "ул. Ладыгина, д.5",
  "forecasts": [
    {
      "date": "2025-10-31",
      "probabilities": {
        "electricity": 0.15,
        "cold_water": 0.05,
        "hot_water": 0.20,
        "heat": 0.10
      },
      "confidence": 0.78
    },
    {
      "date": "2025-11-01",
      "probabilities": {
        "electricity": 0.12,
        "cold_water": 0.04,
        "hot_water": 0.18,
        "heat": 0.08
      },
      "confidence": 0.75
    }
  ],
  "calculated_at": "2025-10-30T00:00:00Z",
  "expires_at": "2025-10-31T00:00:00Z"
}
```

**Response 404:**
```json
{
  "error": "Building not found",
  "message": "Building with ID f6d2bac4f23afdb064b5a2cb89b95f3a not found"
}
```

### 7.2 Endpoint: POST /api/v1/notification-settings

**Описание**: Обновить настройки уведомлений

**Request Body:**
```json
{
  "electricity_enabled": true,
  "cold_water_enabled": true,
  "hot_water_enabled": true,
  "heat_enabled": true,
  "probability_threshold": 0.5,
  "push_enabled": true,
  "email_enabled": true,
  "sms_enabled": false,
  "quiet_hours_start": "22:00",
  "quiet_hours_end": "08:00"
}
```

**Response 200:**
```json
{
  "success": true,
  "settings": { /* same as request */ },
  "updated_at": "2025-10-30T10:30:00Z"
}
```

### 7.3 Endpoint: GET /api/v1/building/{building_id}/history

**Описание**: Получить историю отключений для здания

**Query Parameters:**
- `months`: Количество месяцев назад (default: 6, max: 24)

**Response 200:**
```json
{
  "building_id": "f6d2bac4f23afdb064b5a2cb89b95f3a",
  "statistics": {
    "total_blackouts": 154,
    "avg_duration_hours": 37.56,
    "most_common_type": "hot_water",
    "most_problematic_month": "April"
  },
  "blackouts": [
    {
      "id": "abc123",
      "type": "hot_water",
      "start_date": "2025-04-15T10:00:00Z",
      "end_date": "2025-04-16T18:00:00Z",
      "duration_hours": 32.0,
      "description": "Авария на теплотрассе"
    }
  ]
}
```

---

## 8. ИНТЕГРАЦИЯ С СУЩЕСТВУЮЩЕЙ СИСТЕМОЙ

### 8.1 Архитектура

```
┌─────────────────────────────────────────────────────────┐
│                     VL.OFF Website                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   Current    │  │   Forecast   │  │ Notification │  │
│  │   Features   │◄─┤   Module     │◄─┤   Service    │  │
│  └──────────────┘  └──────┬───────┘  └──────┬───────┘  │
└───────────────────────────┼──────────────────┼──────────┘
                            │                  │
                            ▼                  ▼
                   ┌──────────────┐  ┌──────────────┐
                   │   Forecast   │  │  Historical  │
                   │   Database   │  │   Database   │
                   └──────────────┘  └──────────────┘
                            │
                            ▼
                   ┌──────────────┐
                   │   ML Model   │
                   │  (Optional)  │
                   └──────────────┘

                Existing Systems:
                ┌──────────────┐  ┌──────────────┐
                │ Push Service │  │ Email Service│
                │ (Firebase)   │  │ (SendGrid)   │
                └──────────────┘  └──────────────┘
```

### 8.2 Точки интеграции

1. **База данных исторических данных**: Уже есть в `blackouts.csv`
2. **Система аутентификации**: Использовать существующую (JWT)
3. **Push-уведомления**: Интеграция с Firebase Cloud Messaging
4. **Email**: SendGrid API
5. **SMS**: Twilio API (для Premium)

---

## 9. КОНТУРЫ РАЗВИТИЯ (Roadmap)

### Фаза 1: MVP (Месяц 1)
**Цель**: Базовая функциональность прогнозирования

**Задачи**:
- Разработка алгоритма прогнозирования
- Создание API endpoints
- Страница прогноза в UI
- Push-уведомления

**Метрики**:
- % пользователей, посетивших страницу прогноза
- Точность прогноза (retrospective validation)

### Фаза 2: Персонализация (Месяц 2)
**Цель**: Улучшение релевантности

**Задачи**:
- Настройки уведомлений
- "Тихие часы"
- История отключений
- Рекомендации по подготовке

**Метрики**:
- % пользователей, настроивших уведомления
- Отписки от уведомлений (-50%)

### Фаза 3: Монетизация (Месяц 3)
**Цель**: Премиум-функционал

**Задачи**:
- SMS-уведомления
- Расширенная аналитика
- Карта прогноза города
- A/B тестирование цен

**Метрики**:
- Конверсия в Premium (цель: 5%)
- ARPU (Average Revenue Per User)
- Отток Premium-пользователей (< 5% в месяц)

---

## 10. МЕТРИКИ УСПЕХА (HEART)

### Happiness
- **NPS по фиче**: >30
- **CSAT (Customer Satisfaction)**: >4.0 из 5.0

### Engagement
- **Частота открытий**: +40%
- **Время в приложении**: +25%

### Adoption
- **Подписки на уведомления**: 60%+
- **Активизация фичи**: 70% от активных пользователей

### Retention
- **30-дневный retention**: +15%
- **7-дневный retention**: +20%

### Task Success
- **Подготовка к отключениям**: 50%+
- **Точность прогнозов**: >60%

---

## 11. РИСКИ И МИТИГАЦИЯ

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Низкая точность прогнозов | Средняя | Критическое | A/B тест, консервативный подход, быстрое обучение |
| Отписки от уведомлений | Высокая | Высокое | Агрессивные настройки, персонализация, A/B тесты |
| Технические проблемы | Низкая | Среднее | Инкрементальный запуск, monitoring, rollback plan |
| Низкое принятие Premium | Средняя | Высокое | Тестирование цен, улучшение value proposition |
| Data quality issues | Средняя | Среднее | Валидация данных, санитизация, fallback алгоритмы |

---

## 12. КРИТЕРИИ ПРИЕМКИ

### Глобальные критерии
- ✅ Все функциональные требования реализованы
- ✅ Все нефункциональные требования соблюдены
- ✅ Метрики достигнуты (минимум через 1 месяц после запуска)
- ✅ Нет критических багов в production (sev-1 = 0)
- ✅ Документация обновлена
- ✅ Тесты покрывают 80%+ кода

### Критерии для каждой фазы
- **Фаза 1**: 50% пользователей открыли страницу прогноза
- **Фаза 2**: 60% пользователей настроили уведомления
- **Фаза 3**: 5% конверсия в Premium

---

**Дата составления**: 2025-10-30  
**Версия**: 1.0  
**Статус**: Готов к разработке

